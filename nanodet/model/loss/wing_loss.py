import torch
import torch.nn as nn

def distance_cost(pre_x, gt_x, alpha=1.03, beta=100):
    cost = torch.sub(pre_x[...,None,:],gt_x[...,None,:,:]).abs().sum(-1) / gt_x.size(-1)
    cost = torch.pow(alpha, cost - beta)
    return cost


class WingLoss(nn.Module):
    def __init__(self, w=10, e=2):
        super(WingLoss, self).__init__()
        # https://arxiv.org/pdf/1711.06753v4.pdf   Figure 5
        self.w = w
        self.e = e
        self.C = self.w - self.w * torch.log(1 + self.w / self.e)

    def forward(self, x, t, sigma=1):
        weight = torch.ones_like(t)
        weight[torch.where(t==-1)] = 0
        diff = weight * (x - t)
        abs_diff = diff.abs()
        flag = (abs_diff.data < self.w).float()
        y = flag * self.w * torch.log(1 + abs_diff / self.e) + (1 - flag) * (abs_diff - self.C)
        return y.sum()